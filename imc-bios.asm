        .area     HOME
        jp        init
        .ds       53
reset:  jp        init
        .ds       43
nmient: jp        nmiwor
;bios imc-1
;v2.0
init:   di
        ld        sp,#0x27ff
        ld        ix,#random
        ld        bc,#512
        ld        e,#1
        ld        d,#0
        exx
        ld        a,#54
        out        (#3),a
        ld        a,#118
        out        (#3),a
        ld        a,#182
        out        (#3),a
        ld        a,#0
        out        (#4),a
        ld        a,#255
        out        (#8),a
        ld        hl,#0x2000
        ld        bc,#0x800
test:   ld        a,#255
        ld        (hl),a
        cp        (hl)
        jr        nz,fail
        ld        a,#85
        ld        (hl),a
        cp        (hl)
        jr        nz,fail
        ld        a,#0
        ld        (hl),a
        cp        (hl)
        jr        nz,fail
        inc        hl
        dec        bc
        ld        a,b
        or        c
        jr        nz,test
        jr        accept
fail:   ld        a,#1
        out        (#0),a
        out        (#0),a
        ld        a,#1
        out        (#4),a
        ld        de,#65535
failwa: dec        de
        ld        a,d
        or        e
        jr        nz,failwa
        jp        0
accept: ld        a,#128
        out        (#12),a
        xor        a
        out        (#12),a
music:  ld        b,#16
        ld        hl,#notes
        ld        a,#1
        out        (#4),a
newnot: ld        a,(hl)
        out        (#0),a
        out        (#2),a
        inc        hl
        ld        a,#0
        out        (#0),a
        out        (#2),a
        ld        de,#32767
muwait: dec        de
        ld        a,d
        or        e
        jr        nz,muwait
        djnz        newnot
        jr        setup
setup:  ld        a,#255
        ld        (#0x2007),a
        ld        a,#0
        out        (#4),a
worker: call        noise
        ld        hl,#0x2000
        ld        a,(hl)
        out        (#0),a
        inc        hl
        ld        a,(hl)
        out        (#0),a
        inc        hl
        call        noise
        ld        a,(hl)
        out        (#1),a
        inc        hl
        ld        a,(hl)
        out        (#1),a
        inc        hl
        call        noise
        ld        a,(hl)
        out        (#2),a
        inc        hl
        ld        a,(hl)
        out        (#2),a
        inc        hl
        inc        hl
        inc        hl
        call        noise
        ld        e,#0
        ld        a,(hl)
        bit        #4,a
        jr        z,noamp0
        ld        a,(#0x2010) ;#amp
noamp0: and        #12 ;%1100
        rrca
        rrca
        or        e
        ld        e,a
        inc        hl
        ld        a,(hl)
        bit        #4,a
        jr        z,noamp1
        ld        a,(#0x2010) ;#amp
noamp1: and        #12; %1100
        or        e
        ld        e,a
        inc        hl
        ld        a,(hl)
        bit        #4,a
        jr        z,noamp2
        ld        a,(#0x2010) ;#amp
noamp2: and        #12; %1100
        rlca
        rlca
        or        e
        out        (#8),a
        jr        worker
noise:  exx
        ld        a,(#0x2007)
        and       #56
        cp        #56
        jr        z,nonois
        dec        e
        jr        nz,nonois
        ld        a,(#0x2006)
        ld        e,a
        ld        a,(#0x2007)
        cpl
        ld        h,a
        ld        a,0(ix)
        and       #56 ;%111000
        and        h
        ld        d,a
        inc        ix
        dec        bc
        ld        a,b
        or        c
        jr        nz,nonois
        ld        ix,#random
        ld        bc,#512
nonois: ld        a,(#0x2007)
        and       #7
        xor       #7
        or        d
        out        (#4),a
        exx
        ret
nmiwor: push        af
        push        hl
        in        a,(#4)
        and       #31
        cp        #16
        jr        z,zend
        and       #15
        ld        l,a
        ld        h,#0x20
        in        a,(#8)
        ld        (hl),a
        ld        a,#128
        out        (#12),a
        xor        a
        out        (#12),a
        pop        hl
        pop        af
        retn
zend:   .db        #255,#255,#255

        .area CONST
notes:  .db        #0x70,#0x70
        .db        #0x5e
        .db        #0x70
        .db        #0x96,#0x96
        .db        #0x70
        .db        #0x96
        .db        #0xbd,#0xbd
        .db        #0x96
        .db        #0xbd
        .db        #0xe0,#0xe0
        .db        #0xe0,#0xe0
random:
        .db #0x59, #0x03, #0x3f, #0xba, #0x4b, #0x45, #0x0c, #0xbc, #0xfa, #0xe1, #0x60, #0x90
        .db #0x2f, #0x6b, #0xb5, #0x7b, #0xd6, #0x7d, #0xce, #0x82, #0x2a, #0xf8, #0xb7, #0xb3
        .db #0xa1, #0x10, #0x8f, #0xcf, #0x51, #0x44, #0x85, #0xc0, #0x41, #0x4f, #0x40, #0x1d
        .db #0x6c, #0x53, #0x37, #0x74, #0xe1, #0x6a, #0x6b, #0x3d, #0xab, #0xc7, #0x9c, #0xb2
        .db #0xce, #0x83, #0x10, #0xb0, #0xef, #0x28, #0x58, #0x23, #0x2f, #0x0b, #0x19, #0x85
        .db #0x3f, #0x34, #0x6f, #0x5c, #0x12, #0x16, #0x66, #0xc8, #0x0b, #0xe4, #0x74, #0x7c
        .db #0xa3, #0x93, #0x1e, #0x8e, #0xed, #0x9c, #0x62, #0xaa, #0x67, #0xf4, #0x3e, #0xea
        .db #0xfc, #0xdf, #0x6e, #0xa2, #0x6e, #0x0f, #0xbf, #0x92, #0x6b, #0x49, #0xb7, #0xd7
        .db #0x51, #0x7a, #0x2e, #0x2e, #0x24, #0xc1, #0x75, #0xa2, #0x48, #0xe7, #0x45, #0x42
        .db #0x69, #0x56, #0xa9, #0x70, #0xef, #0xee, #0xb1, #0x6b, #0xed, #0xce, #0x20, #0x85
        .db #0xf5, #0x59, #0xbf, #0x1e, #0x81, #0x30, #0xd3, #0xea, #0xb2, #0x01, #0x35, #0x78
        .db #0xe9, #0x5e, #0xdd, #0x31, #0x64, #0x11, #0x64, #0x2d, #0x55, #0x1f, #0x6a, #0x73
        .db #0x50, #0xc4, #0x30, #0x24, #0x82, #0xd6, #0xb1, #0x57, #0x0a, #0xfe, #0x01, #0xc7
        .db #0x3e, #0xb3, #0x3a, #0x8e, #0xca, #0xe7, #0x0e, #0x98, #0x4f, #0x69, #0x66, #0x12
        .db #0xc7, #0xb1, #0x5f, #0x1a, #0x7e, #0xf5, #0x1c, #0x12, #0xc8, #0x3a, #0xdf, #0x59
        .db #0xa9, #0xe5, #0x9a, #0xbb, #0xdc, #0xa2, #0x88, #0xed, #0x7e, #0x98, #0xb8, #0xc7
        .db #0x67, #0xa4, #0x2f, #0xbc, #0x8e, #0xcd, #0xb9, #0x16, #0x14, #0x2b, #0x85, #0xe7
        .db #0xa7, #0x8f, #0xdc, #0xe9, #0xa2, #0x7c, #0x47, #0xdb, #0xbb, #0x56, #0xa0, #0x67
        .db #0xb7, #0x4e, #0x16, #0x3b, #0x45, #0x43, #0x89, #0xb7, #0x65, #0x0b, #0xcb, #0x9c
        .db #0xdb, #0xca, #0xcf, #0xc5, #0x2c, #0x9b, #0x70, #0xf1, #0xdc, #0x42, #0xe7, #0x1d
        .db #0xcc, #0x8a, #0x70, #0x6f, #0x7a, #0x8a, #0x5e, #0x39, #0x35, #0xcf, #0xb7, #0x67
        .db #0xb6, #0xc5, #0x7e, #0x04, #0xc3, #0x24, #0xc8, #0xbc, #0xc9, #0x7e, #0xf1, #0x28
        .db #0xc6, #0xd0, #0xfd, #0xe9, #0x62, #0xca, #0xf2, #0x11, #0xc8, #0xbd, #0x3b, #0x17
        .db #0xf2, #0x51, #0x6b, #0x1b, #0x89, #0xc0, #0xeb, #0xb9, #0x98, #0xfe, #0x01, #0xd0
        .db #0xf6, #0x27, #0xb3, #0x8e, #0xf0, #0xc5, #0x61, #0x31, #0xb1, #0xd0, #0x50, #0xd2
        .db #0x7f, #0x02, #0x46, #0xef, #0x82, #0x69, #0x1d, #0xec, #0x82, #0xac, #0x68, #0x54
        .db #0x6f, #0x80, #0xf1, #0x68, #0x21, #0x14, #0xf6, #0x82, #0x13, #0xe7, #0x26, #0x2f
        .db #0x07, #0x8d, #0x46, #0x37, #0xf3, #0xa5, #0xf6, #0xf8, #0xe4, #0x7c, #0x49, #0x77
        .db #0x8d, #0xa0, #0x34, #0xef, #0xfd, #0x4a, #0x96, #0x79, #0xb5, #0x52, #0x72, #0x5b
        .db #0x91, #0x0a, #0x0d, #0x00, #0xcc, #0x30, #0x76, #0xbd, #0x22, #0xd4, #0x69, #0x98
        .db #0x53, #0xfb, #0x90, #0x7e, #0xa6, #0x0b, #0xea, #0xd6, #0x54, #0x4e, #0x27, #0x8c
        .db #0xbe, #0xdb, #0x6f, #0x1c, #0x21, #0xe5, #0x6e, #0x22, #0x5d, #0x35, #0x99, #0xe7
        .db #0x8f, #0x17, #0xe4, #0x16, #0xe2, #0xe0, #0x25, #0xe8, #0x1c, #0x78, #0x67, #0xe5
        .db #0x5a, #0x44, #0x42, #0x82, #0xba, #0x31, #0x18, #0x6f, #0x8a, #0x2d, #0x6c, #0x04
        .db #0x72, #0x09, #0x74, #0x92, #0xfe, #0x99, #0xaa, #0x41, #0x46, #0x15, #0x1b, #0xad
        .db #0x10, #0x14, #0x7f, #0x53, #0x86, #0x3e, #0xf9, #0xa3, #0x25, #0x90, #0x51, #0x49
        .db #0xf7, #0x1b, #0x28, #0x67, #0xc7, #0x59, #0x76, #0x90, #0x20, #0x94, #0xc9, #0x2f
        .db #0xcf, #0x82, #0x7c, #0xca, #0x8f, #0x3f, #0x28, #0x43, #0xdd, #0x9c, #0x53, #0x06
        .db #0x12, #0x7b, #0xdc, #0x53, #0x51, #0x7e, #0xb8, #0x89, #0x6d, #0x91, #0x5d, #0x76
        .db #0x0f, #0x2c, #0x0b, #0xfa, #0xf5, #0x5e, #0xc0, #0x17, #0x99, #0x8b, #0x49, #0x39
        .db #0x4f, #0xfe, #0xaa, #0xc9, #0xd4, #0x04, #0x8b, #0x52, #0x0f, #0x32, #0xea, #0x4d
        .db #0x00, #0x2c, #0xd7, #0x82, #0x8e, #0x31, #0x57, #0xb2, #0x9d, #0xe5, #0x54, #0x32
        .db #0xc7, #0x72, #0x50, #0xff, #0x20, #0xeb, #0xa3, #0x5b
